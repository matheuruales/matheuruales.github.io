<!DOCTYPE html>
<html lang="es">
<!-- [Todo el código HTML anterior permanece igual hasta el script] -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // RUTAS MODIFICADAS PARA ARCHIVOS EN LA MISMA CARPETA
        const DATA_PATHS = {
            historical: 'bitcoin.csv',
            predictions: 'predictions.csv'
        };
        
        // API para el precio actual
        const API_URL = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true';
        
        let currentChart = null;
        let historicalData = [];
        let predictionData = [];
        let updateInterval;
        
        // Iniciar la carga de datos
        loadData();
        
        async function loadData() {
            try {
                // Cargar ambos archivos CSV
                const historicalText = await fetchData(DATA_PATHS.historical);
                const predictionsText = await fetchData(DATA_PATHS.predictions);
                
                // Procesar datos
                historicalData = parseCSV(historicalText, true);
                predictionData = parseCSV(predictionsText, false);
                
                // Mostrar datos iniciales
                displayInitialData(historicalData, predictionData);
                
                // Obtener y mostrar el precio actual desde la API
                await updateCurrentPrice();
                
                // Ocultar loading y mostrar contenido
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Iniciar la actualización periódica del precio actual
                startPriceUpdates();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: var(--red); font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Error cargando los datos. Verifica la consola (F12) para más detalles.</p>
                `;
            }
        }
        
        async function fetchData(path) {
            const response = await fetch(path);
            if (!response.ok) {
                throw new Error(`Error al cargar ${path}: ${response.status}`);
            }
            return await response.text();
        }
        
        function parseCSV(csvText, isHistorical) {
            const lines = csvText.split('\n')
                .filter(line => line.trim() !== '')
                .slice(isHistorical ? 3 : 1);
            
            return lines.map(line => {
                const [date, value] = line.split(',');
                return {
                    date: date.trim(),
                    price: parseFloat(value)
                };
            }).filter(item => !isNaN(item.price));
        }
        
        function displayInitialData(historical, predictions) {
            // Obtener últimos valores locales para predicción
            const future = predictions[predictions.length - 1];
            
            // Mostrar valores iniciales (el precio actual se actualizará después)
            document.getElementById('futurePrice').textContent = formatCurrency(future.price);
            
            // Crear gráfico
            createLineChart();
        }
        
        async function updateCurrentPrice() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.status}`);
                }
                const data = await response.json();
                
                const currentPrice = data.bitcoin.usd;
                const priceChange24h = data.bitcoin.usd_24h_change;
                
                // Actualizar el precio actual en la interfaz
                document.getElementById('currentPrice').textContent = formatCurrency(currentPrice);
                
                // Actualizar la variación estimada (usando el último precio local como referencia)
                const futurePriceElement = document.getElementById('futurePrice');
                const futurePrice = parseFloat(futurePriceElement.textContent.replace(/[^0-9.-]+/g,""));
                
                if (!isNaN(futurePrice)) {
                    const change = ((futurePrice - currentPrice) / currentPrice * 100).toFixed(2);
                    const changeElement = document.getElementById('priceChange');
                    changeElement.textContent = (change >= 0 ? '+' : '') + change + '%';
                    changeElement.className = 'metric-value ' + (change >= 0 ? 'positive' : 'negative');
                }
                
            } catch (error) {
                console.error('Error al actualizar el precio:', error);
                // Podrías mostrar un mensaje de error o reintentar
            }
        }
        
        function startPriceUpdates() {
            // Actualizar inmediatamente y luego cada 10 segundos
            updateInterval = setInterval(updateCurrentPrice, 10000);
        }
        
        function createLineChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const allDates = [...historicalData.map(d => d.date), ...predictionData.map(d => d.date)];
            const historicalPrices = [...historicalData.map(d => d.price), ...Array(predictionData.length).fill(null)];
            const predictionPrices = [...Array(historicalData.length).fill(null), ...predictionData.map(d => d.price)];
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: 'Histórico',
                            data: historicalPrices,
                            borderColor: 'rgba(247, 147, 26, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Predicción',
                            data: predictionPrices,
                            borderColor: 'rgba(76, 201, 240, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: getChartOptions()
            });
        }
        
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'rgba(234, 236, 239, 0.9)',
                            font: {
                                family: 'Inter',
                                size: 12
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(10, 11, 14, 0.9)',
                        titleColor: 'rgba(247, 147, 26, 1)',
                        bodyColor: 'rgba(234, 236, 239, 0.9)',
                        borderColor: 'rgba(42, 46, 57, 1)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(42, 46, 57, 0.5)',
                            drawOnChartArea: false
                        },
                        ticks: {
                            color: 'rgba(161, 167, 187, 0.8)',
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(42, 46, 57, 0.5)'
                        },
                        ticks: {
                            color: 'rgba(161, 167, 187, 0.8)',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };
        }
        
        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Limpiar el intervalo cuando la página se cierre
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    });
</script>
</body>
</html>
